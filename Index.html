<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>××©×—×§ ×”×›×ª×‘×” â€“ ××™×œ×™× ×¢×œ ××™×</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #e3f2fd;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}
.card {
  background: white;
  padding: 20px;
  max-width: 520px;
  width: 90%;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  text-align: center;
}
input {
  width: 100%;
  padding: 10px;
  font-size: 1.2rem;
  border-radius: 10px;
  border: 1px solid #ccc;
  margin-top: 8px;
}
button {
  padding: 10px 16px;
  margin: 6px;
  border-radius: 20px;
  cursor: pointer;
  border: none;
  background: #2196f3;
  color: white;
}
button:disabled { opacity: 0.5; }
.feedback.success { color: green; }
.feedback.error { color: red; }
#hud {
  display:flex;
  justify-content:space-between;
  font-size:0.9rem;
  margin-top:10px;
}
.badge {
  font-size:0.9rem;
  color:#555;
}
#wordsStats {
  margin-top: 6px;
  font-size: 0.9rem;
  color:#333;
}

/* ×ª×¢×•×“×ª ×¡×™×•× */
#certificate {
  display:none;
  margin-top:16px;
  padding:16px;
  border:3px double #333;
  border-radius:12px;
  background:#fffdf5;
}
#certificate h3 {
  margin-top:0;
}
</style>
</head>
<body>

<div class="card">
  <h2 id="title">××©×—×§ ×”×›×ª×‘×” ğŸ§ğŸ’§</h2>

  <!-- ××¡×š ×¤×ª×™×—×” ×œ×”×–× ×ª ×©× -->
  <div id="nameScreen">
    <p>××” ×”×©× ×©×œ×š? ğŸ˜Š</p>
    <input id="playerNameInput" placeholder="×”×§×œ×“/×™ ×©×">
    <button onclick="startGameFromName()">×”×ª×—×™×œ ××©×—×§ â–¶ï¸</button>
  </div>

  <!-- ××–×•×¨ ×”××©×—×§ -->
  <div id="gameScreen" style="display:none;">
    <div class="badge">×”×§×©×™×‘×™ ×œ××™×œ×”, ×›×ª×‘×™ × ×›×•×Ÿ, ×¦×‘×¨×™ × ×§×•×“×•×ª ×•×ª×¢×œ×™ ×©×œ×‘×™×! ğŸŒŸ</div>

    <div id="hud">
      <div>â± ×–××Ÿ: <span id="timer">0</span></div>
      <div>â­ ×©×œ×‘: <span id="level">1</span></div>
      <div>ğŸ¯ × ×™×§×•×“: <span id="score">0 / 0</span></div>
    </div>
    <div id="wordsStats">
      ğŸ§® ××™×œ×™× ×©×”×•×©×œ××•: <span id="completedWords">0</span> / <span id="totalWords">0</span>
    </div>

    <input id="answerInput" placeholder="×›×ª×•×‘ ×›××Ÿ ××ª ×”××™×œ×”" disabled>

    <div>
      <button onclick="speak()">×”×©××¢×” ğŸ§</button>
      <button onclick="check()">×‘×“×™×§×” âœ…</button>
      <!-- ××™×œ×” ×—×“×©×” = ×“×™×œ×•×’ â†’ ×”××™×œ×” × ×›× ×¡×ª ×œ×¡×•×£ ×¨×©×™××ª ×”×˜×¢×•×™×•×ª -->
      <button onclick="nextWord(true)">××™×œ×” ×—×“×©×” ğŸ”„</button>
      <button onclick="endGame()">×¡×™×•× ××©×—×§ ğŸ›‘</button>
    </div>

    <div class="feedback" id="feedback"></div>
    <div id="reinforce"></div>

    <!-- ×ª×¢×•×“×ª ×¡×™×•× -->
    <div id="certificate">
      <h3>×ª×¢×•×“×ª ×¡×™×•× ğŸ“</h3>
      <p>
        ×–××ª ×œ×ª×¢×•×“×” ×›×™
        <strong><span id="certName"></span></strong>
        ×¡×™×™×/×” ××ª ××©×—×§ ×”×”×›×ª×‘×” ×¢×œ ××™×
        <br>×‘×”×¦×œ×—×” ××œ××” â€“ ×‘×œ×™ ××£ ×˜×¢×•×ª! ğŸ’¯
      </p>
      <p>×›×œ ×”×›×‘×•×“! ğŸ‘</p>
      <button onclick="window.print()">×”×“×¤×¡ ×ª×¢×•×“×” ğŸ–¨ï¸</button>
      <button onclick="sendSMS()">×©×œ×™×—×ª SMS ğŸ“²</button>
    </div>
  </div>
</div>

<audio id="bgm" loop>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<script>
const ALL_WORDS = ["×˜×œ","×˜×™×¤×”","×œ×˜×¤×˜×£","×˜×•×‘×¢","××©×•×˜","××˜×¨","×××˜×¨×”","×©×˜×¤×•×Ÿ","×××‘×˜×™×”","××¨×˜×™×‘"];

let current = "";
let mainQueue = [];
let errorQueue = [];
let reviewingErrors = false;

let total = 0;          // ×¡×š ×›×œ × ×™×¡×™×•× ×•×ª
let correct = 0;        // ×¡×š ×ª×©×•×‘×•×ª × ×›×•× ×•×ª
let level = 1;
let playerName = "";
let allCorrect = true;  // ×”×× ××¢×•×œ× ×œ× ×”×™×™×ª×” ×˜×¢×•×ª / × ×’××¨ ×”×–××Ÿ

let uniqueCorrect = new Set(); // ××™×œ×™× ×©× ×¢× ×• × ×›×•×Ÿ ×œ×¤×—×•×ª ×¤×¢× ××—×ª

let timeLeft = 0;
let timerId = null;
let locked = false;
let gameActive = false;

const answerInput   = document.getElementById("answerInput");
const feedback      = document.getElementById("feedback");
const reinforce     = document.getElementById("reinforce");
const timerEl       = document.getElementById("timer");
const levelEl       = document.getElementById("level");
const scoreEl       = document.getElementById("score");
const certEl        = document.getElementById("certificate");
const certNameEl    = document.getElementById("certName");
const completedEl   = document.getElementById("completedWords");
const totalWordsEl  = document.getElementById("totalWords");

totalWordsEl.textContent = ALL_WORDS.length;

// ×¦×œ×™×œ×™×
function playTone(freq,d){
  const C = new (window.AudioContext||window.webkitAudioContext)();
  const o = C.createOscillator();
  o.frequency.value=freq; o.connect(C.destination); o.start();
  setTimeout(()=>{o.stop();C.close();},d);
}
function successSound(){
  playTone(900,180);
  setTimeout(()=>playTone(1200,180),220);
}
function errorSound(){
  playTone(400,300);
  setTimeout(()=>playTone(250,400),320);
}

// ××•×–×™×§×ª ×¨×§×¢
function startMusic(){document.getElementById("bgm").play().catch(()=>{});}
function stopMusic(){const b=document.getElementById("bgm");b.pause();b.currentTime=0;}

// ×¢×–×¨
function shuffle(a){return [...a].sort(()=>Math.random()-0.5);}

function updateHUD(){
  timerEl.textContent   = timeLeft;
  levelEl.textContent   = level;
  scoreEl.textContent   = `${correct} / ${total}`;
  completedEl.textContent = uniqueCorrect.size;
}

function calcTime(){
  const t = 18 - (level-1)*2;
  return t < 8 ? 8 : t;
}

// ×”×ª×—×œ×ª ××©×—×§ ××”×©×
function startGameFromName(){
  const name = document.getElementById("playerNameInput").value.trim();
  if(!name){
    alert("×™×© ×œ×”×–×™×Ÿ ×©×");
    return;
  }
  playerName = name;
  document.getElementById("title").textContent = `××©×—×§ ×”×›×ª×‘×” ×©×œ ${playerName}`;
  document.getElementById("nameScreen").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";
  startGame();
}

function startGame(){
  gameActive       = true;
  reviewingErrors  = false;
  mainQueue        = shuffle(ALL_WORDS);
  errorQueue       = [];
  current          = "";
  total            = 0;
  correct          = 0;
  level            = 1;
  allCorrect       = true;
  locked           = false;
  uniqueCorrect    = new Set();
  feedback.textContent   = "";
  feedback.className     = "feedback";
  reinforce.textContent  = "";
  certEl.style.display   = "none";
  updateHUD();
  startMusic();
  nextWord(false);
}

function speak(){
  if(!current) return;
  const u = new SpeechSynthesisUtterance(current);
  u.lang = "he-IL";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

function startTimer(){
  clearInterval(timerId);
  timeLeft = calcTime();
  updateHUD();
  timerId = setInterval(()=>{
    timeLeft--;
    updateHUD();
    if(timeLeft<=0 && !locked){
      handleTimeUp();
    }
  },1000);
}

// ×‘×—×™×¨×ª ××™×œ×” ×”×‘××” ××ª×•×š ×”×ª×•×¨×™×
function pickNextFromQueues(){
  // ×× ×”×ª×•×¨ ×”× ×•×›×—×™ ×¨×™×§ â€“ ×¢×•×‘×¨×™× ×œ×©×œ×‘ ×”×‘×
  if(mainQueue.length === 0){
    if(!reviewingErrors && errorQueue.length > 0){
      // ×¡×™×™×× ×• ××ª ×›×œ ×”××™×œ×™× ×”×¨××©×™×•×ª â†’ ×¢×›×©×™×• ×¢×•×‘×¨×™× ×œ×˜×¢×•×™×•×ª
      reviewingErrors = true;
      mainQueue = shuffle(errorQueue);
      errorQueue = [];
      feedback.textContent = "×¢×›×©×™×• ×—×•×–×¨×™× ×¢×œ ×”××™×œ×™× ×©×”×™×• ×‘×”×Ÿ ×˜×¢×•×™×•×ª ğŸ™‚";
      feedback.className = "feedback";
    } else if(reviewingErrors && errorQueue.length > 0){
      // ×”×™×™× ×• ×›×‘×¨ ×‘×©×œ×‘ ×”×˜×¢×•×™×•×ª, ×•× ×•×¡×¤×• ×˜×¢×•×™×•×ª ×—×“×©×•×ª â†’ × ×¢×‘×•×¨ ×¢×œ×™×”×Ÿ
      mainQueue = shuffle(errorQueue);
      errorQueue = [];
    } else if(reviewingErrors && errorQueue.length === 0){
      // ××™×Ÿ ×™×•×ª×¨ ××™×œ×™× â€“ ×”××©×—×§ × ×’××¨ ××•×˜×•××˜×™×ª
      endGame(true);
      return false;
    } else if(!reviewingErrors && errorQueue.length === 0){
      // ×›×œ ×”××™×œ×™× × ×›×•× ×•×ª ×‘×œ×™ ×˜×¢×•×™×•×ª ×‘×›×œ×œ
      endGame(true);
      return false;
    }
  }

  if(mainQueue.length === 0){
    // ××—×¨×™ ×›×œ ×”××¢×‘×¨×™× ×¢×“×™×™×Ÿ ××™×Ÿ ××™×œ×™× â€“ × ×’××¨
    endGame(true);
    return false;
  }

  current = mainQueue.shift();
  return true;
}

// nextWord(skip=true/false): skip=true ×›×©××©×ª××© ×œ×—×¥ "××™×œ×” ×—×“×©×”"
function nextWord(skip){
  if(!gameActive) return;

  clearInterval(timerId);

  // ×× ×“×™×œ×’× ×• ×¢×œ ××™×œ×” ×§×™×™××ª, ×•×œ× ×”×™×™×ª×” ×¢×“×™×™×Ÿ × ×¢×•×œ×” â€“ ×œ×”×•×¡×™×£ ××•×ª×” ×œ×¡×•×£ ×¨×©×™××ª ×”×˜×¢×•×™×•×ª
  if(skip && !locked && current){
    if(!errorQueue.includes(current)){
      errorQueue.push(current);
    }
  }

  feedback.textContent   = "";
  feedback.className     = "feedback";
  reinforce.textContent  = "";
  answerInput.value      = "";
  answerInput.disabled   = false;
  locked = false;

  if(!pickNextFromQueues()){
    return; // ×”××©×—×§ ×”×¡×ª×™×™×
  }

  answerInput.focus();
  speak();
  startTimer();
}

function handleTimeUp(){
  if(!gameActive) return;
  locked = true;
  total++;
  allCorrect = false; // × ×’××¨ ×”×–××Ÿ = ×œ× ×”×›×•×œ ×”×™×” 100% ××•×©×œ×
  errorSound();
  feedback.textContent = `â± × ×’××¨ ×”×–××Ÿ ${playerName}, ×”××™×œ×” ×”×™×™×ª×”: ${current}`;
  feedback.className   = "feedback error";
  if(!errorQueue.includes(current)){
    errorQueue.push(current);
  }
  answerInput.disabled = true;
  updateHUD();
  clearInterval(timerId);
  setTimeout(()=>nextWord(false),2000);
}

function check(){
  if(!gameActive || !current || locked) return;
  locked = true;
  clearInterval(timerId);
  total++;

  const val = answerInput.value.trim();
  if(val === current){
    correct++;
    successSound();
    feedback.textContent = `×›×œ ×”×›×‘×•×“ ${playerName}! âœ…`;
    feedback.className   = "feedback success";
    uniqueCorrect.add(current);
    maybeLevelUp();
  } else {
    allCorrect = false; // ×˜×¢×•×ª ×›×œ×©×”×™
    errorSound();
    feedback.textContent = `×œ× ××“×•×™×§ ${playerName} âŒ ×”××™×œ×”: ${current}`;
    feedback.className   = "feedback error";
    if(!errorQueue.includes(current)){
      errorQueue.push(current);
    }
  }

  answerInput.disabled = true;
  updateHUD();
  setTimeout(()=>nextWord(false),2000);
}

function maybeLevelUp(){
  const newLevel = Math.floor(correct / 5) + 1;
  if(newLevel > level){
    level = newLevel;
    let msg = "";
    if(level === 2) msg = `×•×•××•! ${playerName}, ×¢×œ×™×ª ×œ×©×œ×‘ 2! ğŸ’¦ğŸŒŸ`;
    else if(level === 3) msg = `××™×Ÿ ×¢×œ×™×™×š ${playerName}! ×©×œ×‘ 3! ğŸŒŠğŸ‘‘`;
    else if(level >= 4) msg = `${playerName}, ××ª/×” ×××¡×˜×¨/×™×ª ×”××™×œ×™×! ğŸ¤©ğŸ”¥`;
    reinforce.textContent = msg;
  }
}

// ×¡×™×•× ×”××©×—×§
function endGame(auto=false){
  if(!gameActive && !auto) return;
  gameActive = false;
  clearInterval(timerId);
  stopMusic();
  answerInput.disabled = true;

  if(auto){
    // ×ª×¢×•×“×” ×¨×§ ×× ×›×œ ×”××™×œ×™× × ×¢× ×• ×œ×¤×—×•×ª ×¤×¢× ××—×ª, ×‘×œ×™ ××£ ×˜×¢×•×ª/× ×’××¨ ×”×–××Ÿ
    if(allCorrect && uniqueCorrect.size === ALL_WORDS.length && total > 0){
      feedback.textContent = `ğŸ‰ ×›×œ ×”×›×‘×•×“ ${playerName}, ×¡×™×™××ª ××ª ×›×œ ×”××™×œ×™× ×‘×œ×™ ××£ ×˜×¢×•×ª!`;
      feedback.className   = "feedback success";
      certNameEl.textContent = playerName;
      certEl.style.display = "block";
    } else {
      feedback.textContent = `×¡×™×™××ª ××ª ×›×œ ×”××™×œ×™× ${playerName}, ××‘×œ ×”×™×• ×’× ×˜×¢×•×™×•×ª ×‘×“×¨×š ğŸ™‚`;
      feedback.className   = "feedback";
    }
  } else {
    feedback.textContent = `×”××©×—×§ ×”×¡×ª×™×™× ${playerName}. × ×™×§×•×“ ×¡×•×¤×™: ${correct}/${total}`;
    feedback.className   = "feedback success";
  }
}

// ×©×œ×™×—×ª SMS â€“ ×”×™×œ×“/×” ×‘×•×—×¨/×ª ××™×© ×§×©×¨
function sendSMS(){
  if(!playerName) return;
  const msg = `ğŸ“ ×›×œ ×”×›×‘×•×“ ${playerName}! ×¡×™×™××ª×™ ××ª ××©×—×§ ×”×”×›×ª×‘×” ×¢×œ ××™× ×‘×œ×™ ××£ ×˜×¢×•×ª! ğŸ’§`;
  const smsUrl = "sms:?&body=" + encodeURIComponent(msg);
  window.location.href = smsUrl;
}

// Enter = ×‘×“×™×§×”
answerInput.addEventListener("keyup", (e)=>{
  if(e.key === "Enter") check();
});
</script>
</body>
</html>
